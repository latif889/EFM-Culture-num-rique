<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ðŸ“Š Tableau de Bord â€“ Assurances Auto</title>

    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Materialize JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
     <!-- Export PDF -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            background: #f4f6f9;
            font-family: 'Roboto', sans-serif;
        }
        h4 {
            margin-top: 20px;
            margin-bottom: 30px;
            font-weight: 500;
        }
        /* Indicateurs */
        .indicator-card {
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #fff;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .indicator-card:hover {
            transform: translateY(-5px);
        }
        .indicator-card h5 {
            font-size: 1.8rem;
            margin: 10px 0 0 0;
        }
        /* Mini-cartes */
        .summary-card {
            border-radius: 10px;
            padding: 12px 18px;
            font-size: 0.95rem;
            margin: 6px;
            text-align: center;
            color: white;
            display: inline-block;
            min-width: 120px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .summary-card i {
            vertical-align: middle;
            margin-right: 6px;
        }
        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 12px;
        }
        /* Tableau */
        table.highlight > tbody > tr:hover {
            background-color: #e0f7fa;
        }
        .file-field .btn {
            border-radius: 50px;
        }
        .summary-section {
            padding: 20px 10px;
        }
        select {
            background: #fff;
            border-radius: 8px;
        }
        /* Export buttons */
.export-btn{
    border-radius:30px;
    margin:8px 6px;
}

/* Table header */
table thead{
    background:#1e88e5;
    color:white;
}

/* Card shadow stronger */
.card{
    box-shadow:0 8px 16px rgba(0,0,0,0.12);
}

/* Summary cards animation */
.summary-card{
    transition:0.3s;
}
.summary-card:hover{
    transform:scale(1.05);
}

    </style>
</head>
<body>

<div class="container">
    <h4 class="center">ðŸ“Š Tableau de Bord â€“ Assurances Auto</h4>

    <!-- Import Excel -->
    <div class="file-field input-field">
        <div class="btn blue darken-2">
            <span>Importer Excel</span>
            <input type="file" id="excelFile">
        </div>
        <div class="file-path-wrapper">
            <input class="file-path validate" type="text" placeholder="Choisissez votre fichier Excel">
        </div>
    </div>

    <!-- Indicateurs -->
    <div class="row">
        <div class="col s12 m4">
            <div class="indicator-card" style="background: #42a5f5;">
                <span class="card-title">Nombre de contrats</span>
                <h5 id="nbContrats">0</h5>
            </div>
        </div>
        <div class="col s12 m4">
            <div class="indicator-card" style="background: #66bb6a;">
                <span class="card-title">Prime moyenne</span>
                <h5 id="primeMoy">0 MAD</h5>
            </div>
        </div>
        <div class="col s12 m4">
            <div class="indicator-card" style="background: #ffa726;">
                <span class="card-title">Prime totale</span>
                <h5 id="primeTotale">0 MAD</h5>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card white">
        <div class="card-content">
            <div class="row">
                <div class="input-field col s12 m4">
                    <select id="villeFilter">
                        <option value="">Toutes les villes</option>
                    </select>
                    <label>Ville</label>
                </div>
                <div class="input-field col s12 m4">
                    <select id="assuranceFilter">
                        <option value="">Tous les types</option>
                    </select>
                    <label>Type d'assurance</label>
                </div>
                <div class="input-field col s12 m4">
                    <select id="vehiculeFilter">
                        <option value="">Tous les vÃ©hicules</option>
                    </select>
                    <label>Type de vÃ©hicule</label>
                </div>
            </div>
        </div>
    </div>
    <div class="center" style="margin:20px 0">
    <a class="btn red darken-2 export-btn" onclick="exportPDF()">
        <i class="material-icons left">picture_as_pdf</i>Exporter PDF
    </a>
</div>


    <!-- RÃ©partition -->
    <div class="card white summary-section">
        <div class="row">
            <div class="col s12 m6">
                <span class="card-title">RÃ©partition par type d'assurance</span>
                <div id="assuranceSummary"></div>
            </div>
            <div class="col s12 m6">
                <span class="card-title">RÃ©partition par type de vÃ©hicule</span>
                <div id="vehiculeSummary"></div>
            </div>
        </div>
    </div>

    <!-- Tableau -->
    <table class="highlight white">
        <thead>
        <tr>
            <th>Nom & PrÃ©nom</th>
            <th>Ville</th>
            <th>Type Assurance</th>
            <th>Type VÃ©hicule</th>
            <th>Prime Totale (MAD)</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
let data = [];
$(document).ready(function () {
    $('select').formSelect();
});

$("#excelFile").on("change", function (e) {
    const reader = new FileReader();
    reader.onload = function (e) {
        const workbook = XLSX.read(e.target.result, {type: "binary"});
        const sheet = workbook.Sheets["Assurances_Auto"];
        data = XLSX.utils.sheet_to_json(sheet);

        remplirFiltres();
        afficherData(data);
    };
    reader.readAsBinaryString(e.target.files[0]);
});

function remplirFiltres() {
    remplirSelect("#villeFilter", "Ville");
    remplirSelect("#assuranceFilter", "Type_Assurance");
    remplirSelect("#vehiculeFilter", "Type_Vehicule");
    $('select').formSelect();
}

function remplirSelect(id, champ) {
    $(id).find("option:not(:first)").remove();
    [...new Set(data.map(d => d[champ]))].forEach(v => {
        $(id).append(`<option value="${v}">${v}</option>`);
    });
}

$("select").on("change", function () {
    const filtered = data.filter(d =>
        (!$("#villeFilter").val() || d["Ville"] === $("#villeFilter").val()) &&
        (!$("#assuranceFilter").val() || d["Type_Assurance"] === $("#assuranceFilter").val()) &&
        (!$("#vehiculeFilter").val() || d["Type_Vehicule"] === $("#vehiculeFilter").val())
    );
    afficherData(filtered);
});

function afficherData(list) {
    $("#tableBody").empty();
    let total = 0;

    list.forEach(d => {
        total += Number(d["Prime_Totale"]);
        $("#tableBody").append(`
            <tr>
                <td>${d["Nom"]} ${d["PrÃ©nom"]}</td>
                <td>${d["Ville"]}</td>
                <td>${d["Type_Assurance"]}</td>
                <td>${d["Type_Vehicule"]}</td>
                <td>${d["Prime_Totale"]}</td>
            </tr>
        `);
    });

    $("#nbContrats").text(list.length);
    $("#primeTotale").text(total + " MAD");
    $("#primeMoy").text(list.length ? Math.round(total / list.length) + " MAD" : "0 MAD");

    majGraphiques(list);
}

function majGraphiques(list) {
    const repartAssurance = {};
    const repartVehicule = {};

    list.forEach(d => {
        repartAssurance[d["Type_Assurance"]] = (repartAssurance[d["Type_Assurance"]] || 0) + 1;
        repartVehicule[d["Type_Vehicule"]] = (repartVehicule[d["Type_Vehicule"]] || 0) + 1;
    });

    // Assurances avec icÃ´nes et couleurs
    const iconsAssurance = {
        "Tiers": {icon: "shield", color: "#42a5f5"},
        "Tiers+": {icon: "stars", color: "#7e57c2"},
        "Tous Risques": {icon: "assignment_turned_in", color: "#26a69a"}
    };
    const orderAssurance = ["Tiers", "Tiers+", "Tous Risques"];
    let htmlAssurance = "";
    orderAssurance.forEach(type => {
        const count = repartAssurance[type] || 0;
        const {icon, color} = iconsAssurance[type] || {icon: "shield", color: "#90a4ae"};
        htmlAssurance += `
        <div class="summary-card" style="background:${color};">
            <i class="material-icons left">${icon}</i>${type} : ${count}
        </div>`;
    });
    $("#assuranceSummary").html(htmlAssurance);

    // VÃ©hicules avec icÃ´nes et couleurs
    const iconsVehicule = {
        "Voiture": {icon: "directions_car", color: "#ef5350"},
        "Moto": {icon: "motorcycle", color: "#ffca28"},
        "Camion": {icon: "local_shipping", color: "#66bb6a"}
    };
    const orderVehicule = ["Voiture", "Moto", "Camion"];
    let htmlVehicule = "";
    orderVehicule.forEach(type => {
        const count = repartVehicule[type] || 0;
        const {icon, color} = iconsVehicule[type] || {icon: "directions_car", color: "#90a4ae"};
        htmlVehicule += `
        <div class="summary-card" style="background:${color};">
            <i class="material-icons left">${icon}</i>${type} : ${count}
        </div>`;
    });
    $("#vehiculeSummary").html(htmlVehicule);
}
function exportPDF(){
    const element = document.querySelector(".container");
    html2pdf()
      .set({
        filename: 'tableau_assurances_auto.pdf',
        jsPDF: {orientation: 'landscape'},
        html2canvas: {scale: 2}
      })
      .from(element)
      .save();
}


</script>

</body>
</html>